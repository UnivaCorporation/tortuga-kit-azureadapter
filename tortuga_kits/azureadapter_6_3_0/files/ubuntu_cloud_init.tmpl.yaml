# Copyright 2008-2018 Univa Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#cloud-config

runcmd:
  - ( cd /tmp; curl -O http://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb )
  - dpkg -i /tmp/puppetlabs-release-pc1-xenial.deb
  - apt-get update
  - apt-get install -y puppet-agent
  - /opt/puppetlabs/bin/puppet agent --waitforcert 120 --server {{ installer }} --logdest /tmp/puppet_bootstrap.log --onetime

{% if override_dns_domain -%}
write_files:
  - content: |
        # Generated by Tortuga
        nameserver {{ installer_ip_address }}
        search {{ dns_domain }}
    path: /etc/resolv.conf
    permissions: '0644'

bootcmd:
  - echo "supersede domain-name-servers {{ installer_ip_address }};" >>/etc/dhcp/dhclient.conf
  - echo "supersede domain-name \"{{ dns_domain }}\";" >>/etc/dhcp/dhclient.conf
{% endif -%}
